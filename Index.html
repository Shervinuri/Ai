<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>☬SHΞN™ - Gemini Core</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Tahoma', sans-serif; direction: rtl; margin: 0; padding: 0;
      display: flex; justify-content: center; align-items: center;
      height: 100vh; background-color: #0a0a0a; text-align: right;
    }
    #chatbotContainer {
      display: flex; flex-direction: column; width: 90%;
      max-width: 500px; height: 85vh; background-color: #131313;
      border-radius: 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      border: 1px solid #2b2b2b;
      overflow: hidden;
    }
    #faceCtn {
      display: flex; justify-content: center; align-items: center;
      padding: 10px; background-color: #1a1a1a;
      border-bottom: 1px solid #2b2b2b;
    }
    #chatContainer {
      flex: 1; display: flex; flex-direction: column;
      padding: 20px; overflow: hidden;
    }
    #messagesContainerEl {
      flex: 1; overflow-y: auto; display: flex;
      flex-direction: column; gap: 10px; padding-right: 5px; color: #f5f5f5;
    }
    #inputContainer { display: flex; margin-top: 15px; gap: 10px; }
    #userInputEl {
      flex: 1; padding: 12px; border: 1px solid #2b2b2b;
      border-radius: 25px; font-size: 16px; font-family: 'Tahoma', sans-serif;
      text-align: right; background-color: #1f1f1f; color: #f5f5f5;
    }
    #userInputEl:focus { outline: none; border-color: #00e5ff; }
    button {
      padding: 12px 20px; background-color: #00e5ff; color: #000;
      border: none; border-radius: 25px; font-size: 16px; font-weight: bold;
      cursor: pointer; transition: background-color 0.2s;
    }
    button:hover { background-color: #80f2ff; }
    .user-message, .bot-message {
      max-width: 70%; padding: 12px 16px; border-radius: 18px;
      margin-bottom: 8px; word-wrap: break-word;
    }
    .user-message { align-self: flex-end; background-color: #004d7a; }
    .bot-message { align-self: flex-start; background-color: #2c2f33; }
    .typing-indicator { align-self: flex-start; background-color: #2c2f33; padding: 12px 16px; border-radius: 18px; margin-bottom: 8px; display: flex; align-items: center; }
    .typing-indicator span { height: 8px; width: 8px; margin: 0 1px; background-color: #9E9EA1; display: block; border-radius: 50%; opacity: 0.4; animation: 1s blink infinite; }
    .typing-indicator span:nth-of-type(1) { animation-delay: 0s; }
    .typing-indicator span:nth-of-type(2) { animation-delay: 0.33s; }
    .typing-indicator span:nth-of-type(3) { animation-delay: 0.66s; }
    @keyframes blink { 50% { opacity: 1; } }
    .robot-frame { width: 110px; height: 110px; background: #080808; border-radius: 22px; box-shadow: inset 0 2px 5px #000, 0 0 20px rgba(0, 255, 255, 0.2); border: 1px solid #2C2F33; display: flex; align-items: center; justify-content: center; padding: 10px; }
    #faceCanvas { cursor: pointer; }
  </style>
</head>
<body>

  <div id="chatbotContainer">
    <div id="faceCtn">
      <div class="robot-frame">
        <canvas id="faceCanvas" width="96" height="96"></canvas>
      </div>
    </div>
    <div id="chatContainer">
      <div id="messagesContainerEl"></div>
      <div id="inputContainer">
        <input type="text" id="userInputEl" placeholder="متن خود را وارد کنید..." />
        <button id="sendBtn">ارسال</button>
      </div>
    </div>
  </div>

<script>
  // موتور گرافیکی ربات (قلب)
  class RobotFace { /* ... (کد کلاس ربات بدون تغییر) ... */ constructor(canvas, scale = 1) { this.canvas = canvas; this.ctx = canvas.getContext("2d"); this.scale = scale; this.canvas.style.width = canvas.width * scale + "px"; this.canvas.style.height = canvas.height * scale + "px"; this.W = canvas.width; this.H = canvas.height; this.eyeLookX = 0; this.lastBlinkTime = Date.now(); this.currentExpression = "neutral"; this.expressionParams = {}; this.stateResetTimer = null; this.initTracking(); requestAnimationFrame(this.render.bind(this)); } drawEye(cx, cy, width, height, radius) { const ctx = this.ctx; const eyeColor = this.expressionParams.color || '#00eaff'; const glowColor = this.expressionParams.glow || 'rgba(0, 234, 255, 0.4)'; ctx.shadowBlur = 15; ctx.shadowColor = glowColor; ctx.fillStyle = eyeColor; ctx.beginPath(); ctx.roundRect(cx - width / 2, cy - height / 2, width, height, radius); ctx.fill(); ctx.shadowBlur = 0; ctx.globalCompositeOperation = 'source-atop'; ctx.fillStyle = 'rgba(0, 0, 0, 0.25)'; for (let i = 0; i < height; i += 2) { ctx.fillRect(cx - width / 2, cy - height / 2 + i, width, 1); } ctx.globalCompositeOperation = 'source-over'; } render() { this.ctx.clearRect(0, 0, this.W, this.H); if (Date.now() - this.lastBlinkTime > 3000 && Math.random() < 0.01 && this.currentExpression !== 'blink') { this.blink(); } this.expressions[this.currentExpression](this); requestAnimationFrame(this.render.bind(this)); } setExpression(name, params = {}) { if (this.expressions[name]) { this.currentExpression = name; this.expressionParams = params; }} blink() { const oldExpression = this.currentExpression; const oldParams = this.expressionParams; this.setExpression("blink"); setTimeout(() => { this.currentExpression = oldExpression; this.expressionParams = oldParams; }, 200); } initTracking() { const updateLook = (x) => { const ratio = (x - window.innerWidth / 2) / (window.innerWidth / 2); this.eyeLookX = ratio * 12; }; window.addEventListener("mousemove", e => updateLook(e.clientX)); window.addEventListener("touchmove", e => { if (e.touches.length) updateLook(e.touches[0].clientX); }, { passive: true }); } expressions = { neutral: (self) => { const eyeW = 40, eyeH = 40, eyeRadius = 12, eyeY = self.H / 2; const p = self.eyeLookX / 12; const lS = 1 - Math.max(0, p) * 0.25; const rS = 1 + Math.min(0, p) * 0.25; self.drawEye(28 + self.eyeLookX, eyeY, eyeW * lS, eyeH, eyeRadius); self.drawEye(self.W - 28 + self.eyeLookX, eyeY, eyeW * rS, eyeH, eyeRadius); }, blink: (self) => { const bH = 5, eW = 40, eY = self.H / 2; self.drawEye(28, eY, eW, bH, 2); self.drawEye(self.W - 28, eY, eW, bH, 2); }, happy: (self) => { const eW = 42, eH = 42, eR = 14, eY = self.H / 2; self.drawEye(28, eY, eW, eH, eR); self.drawEye(self.W-28, eY, eW, eH, eR); }, angry: (self) => { const eW = 44, eH = 32, eR = 10, eY = self.H / 2; self.drawEye(28 + self.eyeLookX * 0.5, eY, eW, eH, eR); self.drawEye(self.W - 28 + self.eyeLookX * 0.5, eY, eW, eH, eR); }, thinking: (self) => { const eW = 38, eH = 38, eR = 18, eY = self.H / 2; self.drawEye(28, eY, eW, eH, eR); self.drawEye(self.W - 28, eY, eW, eH, eR); } } }

  // API برای اتصال به هوش مصنوعی (مغز)
  const chatbotAPI = {
      face: new RobotFace(document.getElementById('faceCanvas')),
      messagesContainer: document.getElementById('messagesContainerEl'),
      displayMessage(sender, text) { const messageEl = document.createElement('div'); messageEl.classList.add(sender === 'user' ? 'user-message' : 'bot-message'); messageEl.textContent = text; this.messagesContainer.appendChild(messageEl); this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight; },
      setExpression(expressionName, params={}) { this.face.setExpression(expressionName, params); },
      showThinking(isThinking) { let indicator = document.getElementById('typingIndicator'); if (isThinking && !indicator) { indicator = document.createElement('div'); indicator.id = 'typingIndicator'; indicator.classList.add('typing-indicator'); indicator.innerHTML = `<span></span><span></span><span></span>`; this.messagesContainer.appendChild(indicator); this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight; } else if (!isThinking && indicator) { indicator.remove(); } }
  };

  // بخش اتصال UI به API
  const userInput = document.getElementById('userInputEl');
  const sendBtn = document.getElementById('sendBtn');
  const handleSend = async () => {
      const userText = userInput.value.trim();
      if (!userText) return;
      chatbotAPI.displayMessage('user', userText);
      userInput.value = '';
      
      chatbotAPI.showThinking(true);
      chatbotAPI.setExpression('thinking');

      try {
          // ✅✅✅ این بخش کد، پستچی امن شما را صدا می‌زند ✅✅✅
          const response = await fetch('/functions/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt: userText })
          });
          if (!response.ok) { throw new Error("پاسخی از سرور دریافت نشد."); }
          const data = await response.json();
          const botResponse = data.reply;
          const botExpression = data.expression || 'happy';
          
          chatbotAPI.showThinking(false);
          chatbotAPI.displayMessage('bot', botResponse);
          chatbotAPI.setExpression(botExpression);
      } catch (error) {
          console.error("Error:", error);
          chatbotAPI.showThinking(false);
          chatbotAPI.displayMessage('bot', "متاسفانه مشکلی پیش اومد. دوباره امتحان کن.");
          chatbotAPI.setExpression('angry');
      }
  };

  sendBtn.addEventListener('click', handleSend);
  userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleSend(); });
</script>
</body>
</html>
